name: CI/CD with Auto-Changelog Release

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      new_tag: ${{ steps.tag_gen.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Generate Tag
        id: tag_gen
        # Using a date + run_number format for a clean versioning look
        run: echo "tag=$(date +'%Y.%m').${{ github.run_number }}" >> $GITHUB_OUTPUT

  deploy-test:
    needs: build
    runs-on: ubuntu-latest
    environment: Test
    steps:
      - name: Deploy to Test
        run: echo "Deploying version ${{ needs.build.outputs.new_tag }} to Test..."

  deploy-prod:
    needs: [build, deploy-test]
    runs-on: ubuntu-latest
    environment: Production
    permissions:
      contents: write
      pull-requests: read # Required to gather PR titles for the changelog
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetches all history so it can compare tags

      - name: Deploy to Prod
        run: echo "Deploying version ${{ needs.build.outputs.new_tag }} to Production..."

      # 1. This step generates the markdown list of changes
      - name: Generate Release Notes
        id: release_notes
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.build.outputs.new_tag }}
          name: Release v${{ needs.build.outputs.new_tag }}
          generate_release_notes: true # This is the magic toggle
          body: |
            ## What's Changed in this Release
            *Manual approval granted by ${{ github.actor }}*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
